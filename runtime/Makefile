OCAMLBUILD = ocamlbuild -tags safe_string -I ocaml -cflag -g -lflag -g
OCAMLBUILDTEST = $(OCAMLBUILD) -pkg oUnit -I test

MLPOSITIVE = test/positive_serializer.ml test/positive_serializer.mli
MLTREE = test/tree_serializer.ml test/tree_serializer.mli

MLFILES = ocaml/bit_vector.ml ocaml/bit_vector.mli ocaml/serializer_primitives.ml ocaml/serializer_primitives.mli

default: cheerios-runtime

$(MLPOSITIVE) $(MLTREE):
	+$(MAKE) -C .. runtime/$@

positive_test.native: $(MLPOSITIVE) $(MLFILES) script/remove_module.pl test/positive_test.ml
	perl script/remove_module.pl test/positive_serializer
	$(OCAMLBUILDTEST) positive_test.native

tree_test.native: $(MLTREE) $(MLFILES) script/remove_module.pl test/tree_test.ml
	perl script/remove_module.pl test/tree_serializer
	$(OCAMLBUILDTEST) tree_test.native

cheerios-runtime: $(MLFILES) ocaml/cheerios_runtime.mllib
	$(OCAMLBUILD) cheerios_runtime.cma cheerios_runtime.cmxa cheerios_runtime.cmxs

test: positive_test.native tree_test.native
	./positive_test.native
	./tree_test.native

.PHONY: default test clean cheerios-runtime $(MLPOSITIVE) $(MLTREE)

clean:
	ocamlbuild -clean

.NOTPARALLEL: $(MLPOSITIVE)
.NOTPARALLEL: $(MLTREE)
